<!DOCTYPE html>
<!-- MAD Music Africa Direct - Version 1.1 -->
<!-- Last updated: 2026-02-16 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="version" content="1.1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAD - Music Africa Direct</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --sidebar-bg: #f8f8fa;
      --main-bg: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-muted: #999999;
      --border-color: #ebebeb;
      --accent-color: #6366f1;
      --hover-bg: #f0f0f2;
      --player-height: 72px;
      --sidebar-width: 200px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--main-bg);
      color: var(--text-primary);
      width: 1920px;
      height: 1750px;
      overflow: auto;
    }

    /* Top Bar */
    .top-bar {
      height: 40px;
      background: var(--sidebar-bg);
      position: fixed;
      top: 0;
      left: 0;
      width: 1920px;
      z-index: 500;
    }

    /* Layout Container */
    .app-container {
      margin-top: 40px;
      display: flex;
      min-height: calc(100vh - 40px - var(--player-height));
      width: 1920px;
      padding-bottom: var(--player-height);
    }

    /* Left Sidebar */
    .sidebar {
      width: 230px;
      background: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: fixed;
      top: 40px;
      left: 0;
      height: calc(100vh - 40px);
      overflow-y: auto;
      z-index: 500;
    }

    .sidebar-logo {
      padding: 30px 20px 20px;
    }

    .sidebar-logo img {
      max-width: 120px;
      height: auto;
    }

    .sidebar-nav {
      padding: 8px 0;
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .nav-item.active {
      color: var(--accent-color);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      color: var(--text-muted);
    }

    .nav-item:hover svg {
      color: var(--text-secondary);
    }

    .nav-item.active svg {
      color: var(--accent-color);
    }

    .nav-section {
      margin-top: 4px;
    }

    .nav-sub-item {
      padding-left: 48px;
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .nav-sub-item:hover {
      color: var(--text-secondary);
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
      background: #ffffff;
      margin-left: 230px;
    }

    .content-header {
      padding: 32px 24px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .search-container {
      position: relative;
      width: 480px;
    }

    .search-input {
      width: 100%;
      height: 37px;
      padding: 0 14px 0 40px;
      border: none;
      border-radius: 50px;
      font-size: 14px;
      background: var(--sidebar-bg);
      color: var(--text-primary);
      outline: none;
    }

    .search-input:focus {
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      width: 18px;
      height: 18px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notification-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    /* Content Body - Split View */
    .content-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Albums List Section */
    .albums-section {
      width: 480px;
      flex-shrink: 0;
      padding: 30px 24px;
      overflow-y: auto;
    }

    .albums-grid {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .album-card {
      cursor: pointer;
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .album-artwork {
      width: 130px;
      height: 130px;
      border-radius: 0;
      overflow: hidden;
      background: #e8e8e8;
      flex-shrink: 0;
    }

    .album-artwork img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .album-info {
      padding-top: 8px;
    }

    .album-info h3 {
      font-size: 18px;
      font-weight: 600;
      color: #888888;
      margin-bottom: 6px;
    }

    .album-artist {
      font-size: 14px;
      color: #888888;
      margin-bottom: 12px;
    }

    .album-stats {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 13px;
      color: #888888;
    }

    .album-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .album-stat svg {
      width: 16px;
      height: 16px;
    }

    /* Right Panel - Album Detail */
    .detail-panel {
      flex: 1;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 30px 40px;
    }

    .detail-panel.hidden {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999999;
      font-size: 15px;
    }

    .detail-panel.hidden .detail-header,
    .detail-panel.hidden .track-list {
      display: none;
    }

    .detail-header {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .detail-artwork {
      width: 160px;
      height: 160px;
      border-radius: 0;
      overflow: hidden;
      background: #e8e8e8;
      flex-shrink: 0;
    }

    .detail-artwork img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .detail-info {
      padding-top: 8px;
    }

    .detail-info h2 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #888888;
    }

    .detail-info .artist {
      font-size: 15px;
      color: #888888;
      margin-bottom: 12px;
    }

    .detail-stats {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 13px;
      color: #888888;
    }

    .detail-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-stat svg {
      width: 16px;
      height: 16px;
    }

    /* Track List */
    .track-list {
      flex: 1;
      overflow-y: auto;
    }

    .track-item {
      display: flex;
      align-items: center;
      padding: 14px 0;
      gap: 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }

    .track-item:hover {
      background: var(--hover-bg);
      margin: 0 -40px;
      padding-left: 40px;
      padding-right: 40px;
      cursor: pointer;
    }

    .track-item:last-child {
      border-bottom: none;
    }

    .track-number {
      width: 28px;
      text-align: left;
      font-size: 14px;
      color: #888888;
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-name {
      font-size: 14px;
      color: #888888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-duration {
      font-size: 14px;
      color: #888888;
    }

    /* Bottom Player */
    .player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: var(--player-height);
      background: #F5F8FF;
      border-top: 1px solid var(--border-color);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      gap: 20px;
      z-index: 1000;
    }

    .player-bar.visible {
      display: flex;
    }

    .player-track-info {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 180px;
    }

    .player-artwork {
      width: 44px;
      height: 44px;
      border-radius: 0;
      overflow: hidden;
      background: #e8e8e8;
      flex-shrink: 0;
    }

    .player-artwork img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .player-track-details h4 {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .player-track-details span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .player-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
    }

    .player-btn:hover {
      background: var(--hover-bg);
    }

    .player-btn.play-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: 2px solid var(--text-primary);
    }

    .player-btn svg {
      width: 18px;
      height: 18px;
    }

    .player-progress {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 500px;
    }

    .progress-bar {
      flex: 1;
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: var(--text-primary);
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s linear;
    }

    .progress-time {
      font-size: 12px;
      color: var(--text-muted);
      min-width: 36px;
    }

    .player-volume {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .volume-slider {
      width: 70px;
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .volume-fill {
      height: 100%;
      background: var(--text-muted);
      border-radius: 2px;
      width: 70%;
    }

    .volume-icon {
      color: var(--text-muted);
      width: 18px;
      height: 18px;
    }

    /* Placeholder images using gradients */
    .placeholder-1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .placeholder-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .placeholder-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .placeholder-4 {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    .placeholder-5 {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    .placeholder-6 {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar"></div>

  <div class="app-container">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="/img/Madmusiclogonew.png" alt="MAD - Music Africa Direct">
      </div>

      <nav class="sidebar-nav">
        <button class="nav-item active" data-view="home">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
          </svg>
          Home
        </button>

        <button class="nav-item" data-view="tracks">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
          </svg>
          Tracks
        </button>

        <button class="nav-item" data-view="albums">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
          </svg>
          Albums
        </button>

        <div class="nav-section">
          <button class="nav-item" data-view="favourites">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
            Favourite
          </button>
          <button class="nav-item nav-sub-item" data-view="fav-tracks">Tracks</button>
          <button class="nav-item nav-sub-item" data-view="fav-albums">Albums</button>
          <button class="nav-item nav-sub-item" data-view="fav-artists">Singer</button>
        </div>

        <button class="nav-item" data-view="account">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          Account
        </button>

        <button class="nav-item" data-view="settings">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
          </svg>
          Settings
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="content-header">
        <div class="search-container">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="search" class="search-input" placeholder="Search">
        </div>
        <div class="header-actions">
          <button class="notification-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
          </button>
        </div>
      </header>

      <div class="content-body">
        <!-- Albums Grid -->
        <section class="albums-section">
          <div class="albums-grid">
            <!-- Albums will be loaded here dynamically -->
          </div>
        </section>

        <!-- Album Detail Panel -->
        <aside class="detail-panel hidden">
          <div class="placeholder-message">Select an album to view tracks</div>
          <div class="detail-header">
            <div class="detail-artwork"></div>
            <div class="detail-info">
              <h2></h2>
              <p class="artist"></p>
              <div class="detail-stats"></div>
            </div>
          </div>
          <div class="track-list">
            <!-- Tracks will be loaded here dynamically -->
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Bottom Player -->
  <div class="player-bar">
    <div class="player-track-info">
      <div class="player-artwork placeholder-3"></div>
      <div class="player-track-details">
        <h4>It's Time</h4>
        <span>Imagine Dragons</span>
      </div>
    </div>

    <div class="player-controls">
      <button class="player-btn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
        </svg>
      </button>
      <button class="player-btn play-btn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </button>
      <button class="player-btn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
        </svg>
      </button>
    </div>

    <div class="player-progress">
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
      <span class="progress-time">2:56</span>
    </div>

    <div class="player-volume">
      <svg class="volume-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
      </svg>
      <div class="volume-slider">
        <div class="volume-fill"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= PAYMENT & ACCESS TOKEN SYSTEM =========
    const STORAGE_KEY = 'mass_access_token';
    let accessToken = localStorage.getItem(STORAGE_KEY);

    // Check URL for payment callback
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment');
    const paymentToken = urlParams.get('token');

    if (paymentStatus === 'success' && paymentToken) {
      // Store token from payment callback
      localStorage.setItem(STORAGE_KEY, paymentToken);
      accessToken = paymentToken;
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Load payment plans and render them
    // ========= AUDIO PLAYER =========
    let currentAudio = null;
    let currentTrack = null;
    let isPlaying = false;

    function playTrack(track, album) {
      currentTrack = { ...track, album };

      // Update player bar UI
      const playerArtwork = document.querySelector('.player-artwork');
      const playerTitle = document.querySelector('.player-track-details h4');
      const playerArtist = document.querySelector('.player-track-details span');
      const playBtn = document.querySelector('.play-btn');

      if (playerArtwork) {
        playerArtwork.innerHTML = album.artwork ? `<img src="${album.artwork}" alt="${album.title}">` : '';
      }
      if (playerTitle) {
        const fields = track.fields || {};
        const trackName = fields['Track Name'] || track.trackName || 'Unknown Track';
        playerTitle.textContent = trackName;
      }
      if (playerArtist) {
        playerArtist.textContent = album.artist;
      }

      // Get audio source
      const audioSrc = track.audioSrc || track.fields?.S3_URL;
      if (!audioSrc) {
        console.error('No audio source available for track');
        return;
      }

      // Create or update audio element
      if (!currentAudio) {
        currentAudio = new Audio();
        currentAudio.addEventListener('ended', () => {
          isPlaying = false;
          updatePlayButton();
        });
        currentAudio.addEventListener('timeupdate', updateProgressBar);
        currentAudio.addEventListener('loadedmetadata', updateProgressBar);
      }

      currentAudio.src = audioSrc;
      currentAudio.play().then(() => {
        isPlaying = true;
        updatePlayButton();
      }).catch(err => {
        console.error('Playback error:', err);
      });
    }

    function updateProgressBar() {
      if (!currentAudio) return;

      const progressFill = document.querySelector('.progress-fill');
      const currentTimeEl = document.querySelector('.progress-time');

      if (progressFill && currentAudio.duration) {
        const percentage = (currentAudio.currentTime / currentAudio.duration) * 100;
        progressFill.style.width = `${percentage}%`;
      }

      if (currentTimeEl) {
        currentTimeEl.textContent = formatTime(currentAudio.currentTime);
      }
    }

    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function seekToPosition(e) {
      if (!currentAudio || !currentAudio.duration) return;

      const progressBar = e.currentTarget;
      const rect = progressBar.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const percentage = x / rect.width;
      const seekTime = percentage * currentAudio.duration;

      currentAudio.currentTime = seekTime;
      updateProgressBar();
    }

    function togglePlayPause() {
      if (!currentAudio || !currentTrack) return;

      if (isPlaying) {
        currentAudio.pause();
        isPlaying = false;
      } else {
        currentAudio.play().then(() => {
          isPlaying = true;
        }).catch(err => {
          console.error('Playback error:', err);
        });
      }
      updatePlayButton();
    }

    function updatePlayButton() {
      const playBtn = document.querySelector('.play-btn');
      if (!playBtn) return;

      const svg = playBtn.querySelector('svg');
      if (isPlaying) {
        // Show pause icon
        svg.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
      } else {
        // Show play icon
        svg.innerHTML = '<path d="M8 5v14l11-7z"/>';
      }
    }

    // Add play button and progress bar click handlers
    document.addEventListener('DOMContentLoaded', () => {
      const playBtn = document.querySelector('.play-btn');
      if (playBtn) {
        playBtn.addEventListener('click', togglePlayPause);
      }

      const progressBar = document.querySelector('.progress-bar');
      if (progressBar) {
        progressBar.addEventListener('click', seekToPosition);
      }
    });

    // ========= API & DATA LOADING =========

    async function api(endpoint) {
      const headers = { 'Content-Type': 'application/json' };
      if (accessToken) {
        headers['X-Access-Token'] = accessToken;
      }
      const res = await fetch(`/api${endpoint}`, { headers });
      return res.json();
    }

    // ========= SEARCH FUNCTIONALITY =========
    let searchTimeout = null;

    function initSearch() {
      const searchInput = document.querySelector('.search-input');
      if (!searchInput) return;

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();

        // Clear previous timeout
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        // If search is empty, load default random songs
        if (!query) {
          loadRandomSongs();
          return;
        }

        // Don't search until at least 3 characters are typed
        if (query.length < 3) {
          return;
        }

        // Debounce search by 800ms
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 800);
      });

      // Also search on Enter key
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }
          const query = e.target.value.trim();
          if (query) {
            performSearch(query);
          }
        }
      });
    }

    async function performSearch(query) {
      try {
        console.log('Searching for:', query);
        // Use general 'q' parameter for broad search across artist, album, and track name
        const data = await api(`/search?q=${encodeURIComponent(query)}&limit=300`);

        if (data.items && data.items.length > 0) {
          console.log('Search results:', data.items.length, 'tracks');

          // Process search results to add artworkSrc and audioSrc
          const processedItems = data.items.map(item => ({
            ...item,
            artworkSrc: item.fields?.['Tape Files::Artwork_S3_URL'] || null,
            audioSrc: item.fields?.S3_URL || null
          }));

          renderAlbums(processedItems);
        } else {
          // No results found
          const albumsGrid = document.querySelector('.albums-grid');
          if (albumsGrid) {
            albumsGrid.innerHTML = '<p style="color: #888888; padding: 20px;">No results found for "' + query + '"</p>';
          }
        }
      } catch (err) {
        console.error('Search failed:', err);
      }
    }

    async function loadRandomSongs() {
      try {
        const data = await api('/random-songs?count=20');
        const items = data.items || [];
        if (items.length > 0) {
          renderAlbums(items);
        }
      } catch (err) {
        console.error('Failed to load random songs:', err);
      }
    }

    function renderAlbums(items) {
      const albumsGrid = document.querySelector('.albums-grid');
      if (!albumsGrid || !items || items.length === 0) return;

      // Items from random-songs already have artworkSrc and fields
      // Group by album using catalogue number (unique identifier)
      const albumMap = new Map();

      console.log('=== ALBUM GROUPING DEBUG ===');
      console.log('Total tracks to process:', items.length);

      items.forEach((item, index) => {
        const fields = item.fields || {};
        const title = fields['Album Title'] || fields['Album'] || fields['Album Name'] || 'Unknown Album';
        const albumArtist = fields['Album Artist'] || fields['Artist'] || fields['Artist Name'] || 'Unknown Artist';
        const trackArtist = fields['Track Artist'] || fields['Artist'] || fields['Artist Name'] || 'Unknown Artist';
        const trackName = fields['Track Name'];

        // For singles/compilations, use track artist instead of album artist to prevent grouping different artists together
        const isSingleOrCompilation = (title || '').toLowerCase() === 'single' || (title || '').toLowerCase() === 'singles';
        const artist = isSingleOrCompilation ? trackArtist : albumArtist;

        // Use simple delimiter-based key
        const key = `${title}|||${artist}`.toLowerCase();

        // Detailed logging for each track
        console.log(`[${index}] Track: "${trackName}" by Track Artist: "${trackArtist}"`);
        console.log(`  Album Title: "${title}"`);
        console.log(`  Album Artist: "${albumArtist}"`);
        console.log(`  Track Artist: "${trackArtist}"`);
        console.log(`  Is Single/Compilation: ${isSingleOrCompilation ? 'YES' : 'NO'}`);
        console.log(`  Using Artist: "${artist}" (${isSingleOrCompilation ? 'Track Artist' : 'Album Artist'})`);
        console.log(`  Generated Key: "${key}"`);

        if (!albumMap.has(key)) {
          console.log(`  -> CREATING NEW ALBUM: "${title}" by "${artist}"`);
          albumMap.set(key, {
            title: title,
            artist: artist,
            artwork: item.artworkSrc || null,
            tracks: []
          });
        } else {
          console.log(`  -> ADDING TO EXISTING ALBUM`);
        }

        albumMap.get(key).tracks.push({
          ...item,
          trackName: fields['Track Name'] || 'Unknown Track'
        });
      });

      console.log('=== FINAL ALBUM MAP ===');
      albumMap.forEach((album, key) => {
        console.log(`Key: "${key}" -> Album: "${album.title}" by "${album.artist}" (${album.tracks.length} tracks)`);
      });
      console.log('========================');

      // Show all albums
      const albums = Array.from(albumMap.values());
      console.log('Albums to render:', albums);

      albumsGrid.innerHTML = albums.map((album, i) => `
        <div class="album-card" data-index="${i}">
          <div class="album-artwork">
            ${album.artwork ? `<img src="${album.artwork}" alt="${album.title}" loading="lazy" onerror="this.style.display='none'">` : ''}
          </div>
          <div class="album-info">
            <h3>${album.title}</h3>
            <p class="album-artist">${album.artist}</p>
            <div class="album-stats">
              <span class="album-stat">${Math.floor(Math.random() * 40 + 5)}K</span>
              <span class="album-stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                  <path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                </svg>
                ${Math.floor(Math.random() * 30 + 5)}
              </span>
            </div>
          </div>
        </div>
      `).join('');

      // Update detail panel with first album
      if (albums.length > 0) {
        updateDetailPanel(albums[0]);
      }

      // Add click handlers
      document.querySelectorAll('.album-card').forEach((card, i) => {
        card.addEventListener('click', async () => await updateDetailPanel(albums[i]));
      });

      // Show player bar once albums are loaded
      const playerBar = document.querySelector('.player-bar');
      if (playerBar) {
        playerBar.classList.add('visible');
      }

      window._albumsData = albums;
    }

    function formatDuration(duration) {
      if (!duration || duration === '--:--') return duration;
      // Remove leading "00:" if present
      return duration.replace(/^00:/, '');
    }

    async function updateDetailPanel(album) {
      // Scroll to top to see the detail panel
      window.scrollTo({ top: 0, behavior: 'smooth' });

      const detailPanel = document.querySelector('.detail-panel');
      const detailArtwork = document.querySelector('.detail-artwork');
      const detailTitle = document.querySelector('.detail-info h2');
      const detailArtist = document.querySelector('.detail-info .artist');
      const trackList = document.querySelector('.track-list');
      const playerArtwork = document.querySelector('.player-artwork');
      const playerTitle = document.querySelector('.player-track-details h4');
      const playerArtistEl = document.querySelector('.player-track-details span');

      // Remove hidden class to show content
      if (detailPanel) {
        detailPanel.classList.remove('hidden');
      }

      if (detailArtwork) {
        detailArtwork.className = 'detail-artwork';
        detailArtwork.innerHTML = album.artwork ? `<img src="${album.artwork}" alt="${album.title}">` : '';
      }
      if (detailTitle) detailTitle.textContent = album.title;
      if (detailArtist) detailArtist.textContent = album.artist;

      // Fetch full album details from API
      try {
        const albumData = await api(`/album?title=${encodeURIComponent(album.title)}&artist=${encodeURIComponent(album.artist)}`);
        const fullTracks = albumData.items || album.tracks || [];

        if (trackList && fullTracks.length > 0) {
          trackList.innerHTML = fullTracks.map((track, i) => {
            const fields = track.fields || {};
            const trackName = fields['Track Name'] || track.trackName || `Track ${i + 1}`;
            const trackArtist = fields['Track Artist'] || fields['Album Artist'] || album.artist || 'Unknown Artist';
            const duration = fields['Duration'] || fields['Track Duration'] || fields['Length'] || fields['Time'] || '--:--';
            const displayName = `${trackArtist} - ${trackName}`;
            return `
              <div class="track-item" data-track-index="${i}">
                <span class="track-number">${i + 1}.</span>
                <div class="track-info">
                  <div class="track-name">${displayName}</div>
                </div>
                <span class="track-duration">${formatDuration(duration)}</span>
              </div>
            `;
          }).join('');

          // Add click handlers to tracks
          trackList.querySelectorAll('.track-item').forEach((item, i) => {
            item.addEventListener('click', () => {
              playTrack(fullTracks[i], album);
            });
          });
        }
      } catch (err) {
        console.error('Failed to load full album details:', err);
        // Fallback to cached tracks
        if (trackList && album.tracks) {
          trackList.innerHTML = album.tracks.map((track, i) => {
            const fields = track.fields || {};
            const trackName = track.trackName || `Track ${i + 1}`;
            const trackArtist = fields['Track Artist'] || fields['Album Artist'] || album.artist || 'Unknown Artist';
            const duration = fields['Duration'] || fields['Track Duration'] || fields['Length'] || fields['Time'] || '--:--';
            const displayName = `${trackArtist} - ${trackName}`;
            return `
              <div class="track-item" data-track-index="${i}">
                <span class="track-number">${i + 1}.</span>
                <div class="track-info">
                  <div class="track-name">${displayName}</div>
                </div>
                <span class="track-duration">${formatDuration(duration)}</span>
              </div>
            `;
          }).join('');

          // Add click handlers to tracks
          trackList.querySelectorAll('.track-item').forEach((item, i) => {
            item.addEventListener('click', () => {
              playTrack(album.tracks[i], album);
            });
          });
        }
      }

      // Update player bar
      if (playerArtwork) {
        playerArtwork.className = 'player-artwork';
        playerArtwork.innerHTML = album.artwork ? `<img src="${album.artwork}" alt="${album.title}">` : '';
      }
      if (playerTitle && album.tracks && album.tracks.length > 0) {
        playerTitle.textContent = album.tracks[0].trackName || 'Unknown Track';
      }
      if (playerArtistEl) {
        playerArtistEl.textContent = album.artist;
      }
    }

    // Load albums on page load
    async function init() {
      // Initialize search functionality
      initSearch();

      try {
        // Use random-songs endpoint (public, no auth required)
        const data = await api('/random-songs?count=20');
        console.log('API response:', data);
        const items = data.items || [];
        console.log('Loaded items:', items.length);
        if (items.length > 0) {
          renderAlbums(items);
        }
      } catch (err) {
        console.error('Failed to load albums:', err);
      }
    }

    init();
  </script>
</body>
</html>
