<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Library — MASS</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #ffffff;
      --fg: #1a1a1a;
      --muted: #6b6b6b;
      --card: #ffffff;
      --accent: #8b5cf6;
      --border: #e5e5e5;
      --sidebar-bg: #f5f5f7;
      --text-secondary: #666666;
      --hover-bg: #f0f0f2;
      --overlay: rgba(255,255,255,.85);
      --btn-gradient-start: #8b5cf6;
      --btn-gradient-end: #a78bfa;
      --btn-text: #ffffff;
      --btn-shadow: rgba(139,92,246,0.25);
      --player-height: 80px;
      --sidebar-width: 240px;
    }

    body.dark-mode {
      --bg: #121212;
      --fg: #e8e8e8;
      --muted: #999999;
      --card: #1a1a1a;
      --accent: #8b5cf6;
      --border: #333333;
      --sidebar-bg: #1a1a1a;
      --text-secondary: #999999;
      --hover-bg: rgba(255,255,255,0.05);
      --overlay: rgba(18,18,18,.92);
    }

    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--fg);
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
    }

    /* ── Layout ── */
    .app-wrapper { display: flex; height: 100vh; overflow: hidden; }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      height: 100vh;
      overflow-y: auto;
      position: fixed;
      top: 0; left: 0;
      padding-bottom: calc(var(--player-height) + 12px);
    }

    .sidebar-logo {
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--accent);
      text-decoration: none;
      display: block;
    }

    .sidebar-nav { padding: 12px 0; }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--fg);
      cursor: pointer;
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      text-decoration: none;
      transition: background 0.15s ease, color 0.15s ease;
      border-radius: 6px;
      margin: 1px 8px;
      width: calc(100% - 16px);
    }
    .nav-item:hover { background: var(--hover-bg); }
    .nav-item.active { font-weight: 600; color: var(--accent); background: rgba(139,92,246,0.08); }
    .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; color: var(--accent); }

    .nav-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 20px 4px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 8px;
    }

    /* ── Main ── */
    .main-wrapper {
      flex: 1;
      margin-left: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100vh;
    }

    .page-header {
      padding: 24px 28px 0;
      flex-shrink: 0;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 20px;
    }

    /* ── Tabs ── */
    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid var(--border);
      padding: 0 28px;
      flex-shrink: 0;
    }

    .tab-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      background: none;
      border: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: color 0.15s, border-color 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-btn:hover { color: var(--fg); }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-count {
      font-size: 11px;
      background: var(--border);
      color: var(--muted);
      padding: 1px 7px;
      border-radius: 999px;
      font-weight: 600;
    }
    .tab-btn.active .tab-count { background: rgba(139,92,246,0.15); color: var(--accent); }

    /* ── Filter bar ── */
    .filter-bar {
      padding: 14px 28px;
      flex-shrink: 0;
    }

    .filter-input {
      width: 280px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--fg);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }
    .filter-input:focus { border-color: var(--accent); }
    .filter-input::placeholder { color: var(--muted); }

    /* ── Scroll content ── */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 0 28px 20px;
      display: none;
    }
    .tab-content.active { display: block; }

    /* ── Empty state ── */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      color: var(--muted);
      text-align: center;
    }
    .empty-state svg { margin-bottom: 16px; opacity: 0.35; }
    .empty-state h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--fg); }
    .empty-state p { font-size: 14px; line-height: 1.6; max-width: 340px; }

    /* ── Songs list ── */
    .songs-list { display: flex; flex-direction: column; gap: 2px; }

    .song-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.1s;
    }
    .song-row:hover { background: var(--hover-bg); }
    .song-row.playing { background: rgba(139,92,246,0.08); }
    .song-row.playing .song-name { color: var(--accent); }
    .song-row.hidden-filter { display: none; }

    .song-art {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      object-fit: cover;
      background: var(--border);
      flex-shrink: 0;
    }

    .song-info { flex: 1; min-width: 0; }
    .song-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .song-meta {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .song-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: none;
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
      flex-shrink: 0;
    }
    .icon-btn:hover { background: var(--hover-bg); color: var(--fg); }
    .icon-btn.remove:hover { color: #e05252; }
    .icon-btn svg { width: 16px; height: 16px; }

    /* ── Albums grid ── */
    .albums-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
      padding-top: 4px;
    }

    .album-card {
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      background: var(--card);
      border: 1px solid var(--border);
      position: relative;
    }
    .album-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .album-card.hidden-filter { display: none; }

    .album-card-art {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      background: var(--border);
      display: block;
    }

    .album-card-info {
      padding: 10px 10px 8px;
    }
    .album-card-title {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .album-card-artist {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }
    .album-card-year {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .album-card-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0,0,0,0.55);
      border: none;
      color: #fff;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      line-height: 1;
      transition: background 0.15s;
    }
    .album-card:hover .album-card-remove { display: flex; }
    .album-card-remove:hover { background: rgba(200,50,50,0.85); }

    /* ── Mini Player ── */
    .mini-player {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: var(--player-height);
      background: var(--sidebar-bg);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 20px;
      z-index: 1000;
    }
    .mini-player-left { display: flex; align-items: center; gap: 10px; min-width: 220px; flex: 1; overflow: hidden; }
    .mini-player-artwork {
      width: 48px; height: 48px;
      border-radius: 6px;
      overflow: hidden;
      background: var(--border);
      flex-shrink: 0;
    }
    .mini-player-artwork img { width: 100%; height: 100%; object-fit: cover; }
    .mini-player-info { min-width: 0; }
    .mini-player-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mini-player-artist { font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .mini-player-center { display: flex; align-items: center; gap: 10px; flex: 2; justify-content: center; }
    .player-btn {
      background: none; border: none; cursor: pointer; color: var(--fg);
      display: flex; align-items: center; justify-content: center;
      padding: 6px; border-radius: 50%; transition: background 0.15s;
    }
    .player-btn:hover { background: var(--hover-bg); }
    .player-btn.play-pause {
      width: 40px; height: 40px;
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
    }
    .player-btn.play-pause:hover { opacity: 0.9; background: var(--accent); }

    .player-progress-bar {
      flex: 1; max-width: 300px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }
    .player-progress-fill {
      height: 100%; background: var(--accent); border-radius: 2px;
      pointer-events: none; width: 0%;
    }
    .player-time { font-size: 11px; color: var(--muted); white-space: nowrap; }

    .mini-player-right { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end; min-width: 140px; }
    .player-volume-btn { background: none; border: none; cursor: pointer; color: var(--muted); display: flex; align-items: center; padding: 4px; }
    .player-volume-slider { width: 80px; height: 4px; background: var(--border); border-radius: 2px; cursor: pointer; position: relative; }
    .player-volume-fill { height: 100%; background: var(--accent); border-radius: 2px; width: 80%; pointer-events: none; }

    /* ── Loading spinner ── */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--muted);
      gap: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      width: 20px; height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
  </style>
</head>
<body>

  <!-- Hidden audio element -->
  <audio id="player" preload="none" style="display:none"></audio>

  <div class="app-wrapper">

    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="/albums" class="sidebar-logo">MASS</a>
      <nav class="sidebar-nav">
        <a href="/albums" class="nav-item">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
          Home
        </a>

        <div class="nav-section-header">Library</div>

        <a href="/library?tab=songs" class="nav-item" id="navSongs">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
          Songs
        </a>
        <a href="/library?tab=albums" class="nav-item" id="navAlbums">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
          Albums
        </a>
      </nav>
    </aside>

    <!-- Main content -->
    <div class="main-wrapper">

      <div class="page-header">
        <h1 class="page-title">My Library</h1>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabs">
        <button class="tab-btn active" data-tab="songs" id="tabBtnSongs">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
          Songs
          <span class="tab-count" id="songsCount">0</span>
        </button>
        <button class="tab-btn" data-tab="albums" id="tabBtnAlbums">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
          Albums
          <span class="tab-count" id="albumsCount">0</span>
        </button>
      </div>

      <!-- Filter bar -->
      <div class="filter-bar">
        <input type="search" class="filter-input" id="filterInput" placeholder="Filter by name or artist…" autocomplete="off">
      </div>

      <!-- Songs tab -->
      <div class="tab-content active" id="tabSongs">
        <div class="loading" id="songsLoading">
          <div class="spinner"></div> Loading…
        </div>
        <div class="songs-list" id="songsList" style="display:none"></div>
        <div class="empty-state" id="songsEmpty" style="display:none">
          <svg width="56" height="56" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
          <h3>No saved songs yet</h3>
          <p>Browse albums and tap <strong>♡ Songs</strong> on any track to save it here.</p>
        </div>
      </div>

      <!-- Albums tab -->
      <div class="tab-content" id="tabAlbums">
        <div class="loading" id="albumsLoading">
          <div class="spinner"></div> Loading…
        </div>
        <div class="albums-grid" id="albumsGrid" style="display:none"></div>
        <div class="empty-state" id="albumsEmpty" style="display:none">
          <svg width="56" height="56" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
          <h3>No saved albums yet</h3>
          <p>Browse albums and tap <strong>♡ Albums</strong> on any album to save it here.</p>
        </div>
      </div>

    </div><!-- /.main-wrapper -->
  </div><!-- /.app-wrapper -->

  <!-- Mini Player -->
  <div class="mini-player" id="miniPlayer">
    <div class="mini-player-left">
      <div class="mini-player-artwork" id="nowPlayingThumb">
        <img src="" alt="Album artwork" id="nowPlayingThumbImg">
      </div>
      <div class="mini-player-info">
        <div class="mini-player-title" id="nowPlayingTitle"></div>
        <div class="mini-player-artist" id="nowPlayingSubtitle"></div>
      </div>
    </div>
    <div class="mini-player-center">
      <button class="player-btn" id="playerPrev" title="Previous">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
      </button>
      <button class="player-btn play-pause" id="nowPlayingToggle" title="Play/Pause">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" id="playIcon">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </button>
      <button class="player-btn" id="playerNext" title="Next">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
      </button>
      <div class="player-progress-bar" id="playerProgressBar">
        <div class="player-progress-fill" id="nowPlayingProgressFill"></div>
      </div>
      <span class="player-time" id="playerCurrentTime">0:00</span>
    </div>
    <div class="mini-player-right">
      <button class="player-volume-btn" id="volumeBtn" title="Volume">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
      </button>
      <div class="player-volume-slider" id="volumeSlider">
        <div class="player-volume-fill" id="volumeFill"></div>
      </div>
    </div>
  </div>

  <!-- app.min.js handles mini-player, volume, progress, prev/next -->
  <script>
    // IMPORTANT: run BEFORE app.min.js to intercept fetch
    const _origFetch = window.fetch;
    window.fetch = function(url, opts = {}) {
      const urlStr = typeof url === 'string' ? url : (url?.url || '');
      const isApi = urlStr.startsWith('/api/') || urlStr.includes(location.origin + '/api/');
      const isPublic = ['/api/access/validate', '/api/wake', '/api/public-playlists',
        '/api/featured-albums'].some(p => urlStr.includes(p)) || /\/api\/shared-playlists\//.test(urlStr);
      if (isApi && !isPublic) {
        const token = localStorage.getItem('mass_access_token');
        if (token) {
          opts.headers = Object.assign({}, opts.headers, { 'X-Access-Token': token });
        }
      }
      return _origFetch.call(this, url, opts);
    };

    // Prevent app.min.js from loading featured albums and overriding page
    window.__LIBRARY_PAGE__ = true;
  </script>
  <script defer src="/app.min.js?v=94"></script>
  <script>
    (async function() {
      const player = document.getElementById('player');
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = { songs: document.getElementById('tabSongs'), albums: document.getElementById('tabAlbums') };
      const filterInput = document.getElementById('filterInput');
      const songsList = document.getElementById('songsList');
      const albumsGrid = document.getElementById('albumsGrid');
      const songsCount = document.getElementById('songsCount');
      const albumsCount = document.getElementById('albumsCount');
      const navSongs = document.getElementById('navSongs');
      const navAlbums = document.getElementById('navAlbums');

      // ── Auth check ──
      try {
        const me = await fetch('/api/auth/me');
        if (!me.ok) { window.location.href = '/albums'; return; }
      } catch { window.location.href = '/albums'; return; }

      // ── Tab switching ──
      let currentTab = new URLSearchParams(location.search).get('tab') || 'songs';

      function activateTab(tab) {
        currentTab = tab;
        tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
        Object.entries(tabContents).forEach(([k, el]) => el.classList.toggle('active', k === tab));
        navSongs.classList.toggle('active', tab === 'songs');
        navAlbums.classList.toggle('active', tab === 'albums');
        const url = new URL(location.href);
        url.searchParams.set('tab', tab);
        history.replaceState({}, '', url);
        applyFilter(filterInput.value);
      }

      tabBtns.forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));
      activateTab(currentTab);

      // ── Filter ──
      function applyFilter(q) {
        const term = q.toLowerCase().trim();
        if (currentTab === 'songs') {
          document.querySelectorAll('.song-row').forEach(row => {
            const match = !term || row.dataset.search.includes(term);
            row.classList.toggle('hidden-filter', !match);
          });
        } else {
          document.querySelectorAll('.album-card').forEach(card => {
            const match = !term || card.dataset.search.includes(term);
            card.classList.toggle('hidden-filter', !match);
          });
        }
      }
      filterInput.addEventListener('input', () => applyFilter(filterInput.value));

      // ── Playback helpers ──
      let nowPlayingId = null;

      function playUrl(url, song) {
        if (url && /^https?:\/\//i.test(url) && !url.includes('.s3.') && !url.includes('.s3-') && !url.includes('/api/container?')) {
          url = '/api/container?u=' + encodeURIComponent(url);
        }
        if (!url) return;
        player.src = url;
        player.play().catch(e => console.warn('[Library] play error', e));
        // Update mini-player display
        const title = document.getElementById('nowPlayingTitle');
        const subtitle = document.getElementById('nowPlayingSubtitle');
        const thumb = document.getElementById('nowPlayingThumbImg');
        if (title) title.textContent = song.name || '';
        if (subtitle) subtitle.textContent = [song.trackArtist || song.albumArtist, song.albumTitle].filter(Boolean).join(' — ');
        if (thumb && song.artwork) thumb.src = song.artwork;
        nowPlayingId = song.id;
        document.querySelectorAll('.song-row').forEach(r => r.classList.toggle('playing', r.dataset.id === song.id));
      }

      // ── Load library data ──
      async function loadLibrary() {
        let songs = [], albums = [];
        try {
          const res = await fetch('/api/library');
          if (res.ok) { const d = await res.json(); songs = d.songs || []; albums = d.albums || []; }
        } catch(e) { console.error('[Library] load error', e); }

        renderSongs(songs);
        renderAlbums(albums);
      }

      // ── Render songs ──
      function renderSongs(songs) {
        document.getElementById('songsLoading').style.display = 'none';
        songsCount.textContent = songs.length;

        if (!songs.length) {
          document.getElementById('songsEmpty').style.display = 'flex';
          return;
        }

        songsList.style.display = 'flex';
        songsList.innerHTML = '';

        songs.forEach(song => {
          const row = document.createElement('div');
          row.className = 'song-row';
          row.dataset.id = song.id;
          row.dataset.search = (song.name + ' ' + (song.trackArtist || '') + ' ' + (song.albumArtist || '') + ' ' + (song.albumTitle || '')).toLowerCase();

          const artSrc = song.artwork || '/img/placeholder.jpg';
          const meta = [song.trackArtist || song.albumArtist, song.albumTitle].filter(Boolean).join(' — ');

          row.innerHTML = `
            <img class="song-art" src="${escHtml(artSrc)}" alt="" loading="lazy" onerror="this.src='/img/placeholder.jpg'">
            <div class="song-info">
              <div class="song-name">${escHtml(song.name)}</div>
              <div class="song-meta">${escHtml(meta)}</div>
            </div>
            <div class="song-actions">
              <button class="icon-btn play-btn" title="Play">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
              </button>
              <button class="icon-btn remove" title="Remove from library">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H5v-2h14v2z"/></svg>
              </button>
            </div>`;

          const audioUrl = song.S3_URL || song.mp3 || '';

          row.querySelector('.play-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            playUrl(audioUrl, song);
          });

          row.addEventListener('click', () => playUrl(audioUrl, song));

          row.querySelector('.remove').addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
              const res = await fetch('/api/library/songs/' + song.id, { method: 'DELETE' });
              if ((await res.json()).ok) {
                row.remove();
                const remaining = document.querySelectorAll('.song-row').length;
                songsCount.textContent = remaining;
                if (!remaining) { document.getElementById('songsEmpty').style.display = 'flex'; }
              }
            } catch(e) { console.error('[Library] remove song error', e); }
          });

          songsList.appendChild(row);
        });
      }

      // ── Render albums ──
      function renderAlbums(albums) {
        document.getElementById('albumsLoading').style.display = 'none';
        albumsCount.textContent = albums.length;

        if (!albums.length) {
          document.getElementById('albumsEmpty').style.display = 'flex';
          return;
        }

        albumsGrid.style.display = 'grid';
        albumsGrid.innerHTML = '';

        albums.forEach(album => {
          const card = document.createElement('div');
          card.className = 'album-card';
          card.dataset.search = (album.title + ' ' + album.artist).toLowerCase();

          const artSrc = album.artwork || '/img/placeholder.jpg';

          card.innerHTML = `
            <img class="album-card-art" src="${escHtml(artSrc)}" alt="" loading="lazy" onerror="this.src='/img/placeholder.jpg'">
            <div class="album-card-info">
              <div class="album-card-title">${escHtml(album.title)}</div>
              <div class="album-card-artist">${escHtml(album.artist || '')}</div>
              ${album.year ? `<div class="album-card-year">${escHtml(String(album.year))}</div>` : ''}
            </div>
            <button class="album-card-remove" title="Remove from library">✕</button>`;

          // Click card → go to albums page with this album
          card.addEventListener('click', (e) => {
            if (e.target.classList.contains('album-card-remove')) return;
            const params = new URLSearchParams({ album: album.title, artist: album.artist || '' });
            window.location.href = '/albums?' + params.toString();
          });

          card.querySelector('.album-card-remove').addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
              const res = await fetch('/api/library/albums/' + album.id, { method: 'DELETE' });
              if ((await res.json()).ok) {
                card.remove();
                const remaining = document.querySelectorAll('.album-card').length;
                albumsCount.textContent = remaining;
                if (!remaining) { document.getElementById('albumsEmpty').style.display = 'flex'; }
              }
            } catch(e) { console.error('[Library] remove album error', e); }
          });

          albumsGrid.appendChild(card);
        });
      }

      function escHtml(str) {
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      // ── Init ──
      loadLibrary();

      // ── Mini-player toggle (fallback when app.min.js meta is null) ──
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('#nowPlayingToggle');
        if (!btn) return;
        if (player.paused) player.play().catch(() => {});
        else player.pause();
      });

      // ── Progress bar ──
      player.addEventListener('timeupdate', () => {
        const fill = document.getElementById('nowPlayingProgressFill');
        const timeEl = document.getElementById('playerCurrentTime');
        if (!player.duration) return;
        const pct = (player.currentTime / player.duration) * 100;
        if (fill) fill.style.width = pct + '%';
        if (timeEl) {
          const m = Math.floor(player.currentTime / 60);
          const s = Math.floor(player.currentTime % 60).toString().padStart(2, '0');
          timeEl.textContent = m + ':' + s;
        }
      });

      // Seek on click
      const progressBar = document.getElementById('playerProgressBar');
      if (progressBar) {
        progressBar.addEventListener('click', (e) => {
          if (!player.duration) return;
          const rect = progressBar.getBoundingClientRect();
          player.currentTime = ((e.clientX - rect.left) / rect.width) * player.duration;
        });
      }

    })();
  </script>
</body>
</html>
